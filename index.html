<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Josh's Simple Gains</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #000; min-height: 100vh; padding: 16px; color: #fff; }
        .container { max-width: 480px; margin: 0 auto; background: linear-gradient(145deg, #1d1d1f 0%, #121212 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%); color: #fff; padding: 28px 24px 24px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .header h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; margin-bottom: 4px; }
        .header p { font-size: 13px; color: rgba(255, 255, 255, 0.5); }
        .header a { display: inline-block; margin-top: 8px; color: rgba(255, 255, 255, 0.6); font-size: 13px; text-decoration: none; }
        .workout-selector { display: flex; background: rgba(255, 255, 255, 0.08); padding: 8px; gap: 6px; }
        .workout-btn { flex: 1; padding: 14px 10px; border: none; background: transparent; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; }
        .workout-btn.active { background: rgba(255, 255, 255, 0.12); color: #fff; }
        .content { padding: 16px; }
        .exercise-card { background: #fff; border-radius: 16px; padding: 18px; margin-bottom: 12px; color: #1d1d1f; }
        .exercise-card.completed { background: #f5f5f5; opacity: 0.7; }
        .exercise-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .exercise-title { font-size: 22px; font-weight: 600; color: #1d1d1f; }
        .ready-badge { background: linear-gradient(135deg, #34a853 0%, #2d9648 100%); color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .pending-badge { background: linear-gradient(135deg, #fbbc04 0%, #f9a825 100%); color: #1d1d1f; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .deload-badge { background: linear-gradient(135deg, #ff3b30 0%, #d63229 100%); color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .restart-btn { display: none; width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: transparent; color: #ff9500; margin-top: 8px; }
        .restart-btn.show { display: block; }
        .restart-btn:active { opacity: 0.7; }
        .metrics-section { padding: 16px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .metrics-title { color: #fff; font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .metrics-title span { color: rgba(255, 255, 255, 0.5); font-weight: 400; font-size: 12px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .metric-card { background: rgba(255, 255, 255, 0.06); border-radius: 12px; padding: 12px; text-align: center; }
        .metric-value { font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .metric-value.positive { color: #34a853; }
        .metric-value.negative { color: #ff3b30; }
        .metric-value.neutral { color: #ff9500; }
        .metric-label { font-size: 11px; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px; }
        .exercise-changes { margin-top: 10px; }
        .exercise-change { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.06); font-size: 12px; }
        .exercise-change:last-child { border-bottom: none; }
        .exercise-change-name { color: rgba(255, 255, 255, 0.7); }
        .exercise-change-value { font-weight: 600; }
        .exercise-change-value.up { color: #34a853; }
        .exercise-change-value.down { color: #ff3b30; }
        .exercise-change-value.same { color: rgba(255, 255, 255, 0.4); }
        .weight-row { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .weight-label { font-size: 15px; font-weight: 500; color: #666; }
        .weight-input { width: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 18px; font-weight: 600; text-align: center; }
        .weight-input:focus { outline: none; border-color: #007aff; }
        .weight-unit { font-size: 15px; color: #666; }
        .sets-container { display: flex; gap: 10px; }
        .set-box { flex: 1; background: #f5f5f7; border-radius: 12px; padding: 14px; text-align: center; }
        .set-label { font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; text-transform: uppercase; }
        .set-time { font-size: 28px; font-weight: 700; color: #1d1d1f; font-variant-numeric: tabular-nums; }
        .set-time.counting { color: #007aff; }
        .set-time.countdown { color: #ff9500; }
        .set-time.success { color: #34a853; }
        .lr-container { display: flex; gap: 8px; margin-bottom: 10px; }
        .lr-box { flex: 1; background: #f5f5f7; border-radius: 10px; padding: 12px 8px; text-align: center; }
        .lr-label { font-size: 11px; font-weight: 600; color: rgba(60, 60, 67, 0.5); margin-bottom: 6px; text-transform: uppercase; }
        .set-time.small { font-size: 24px; }
        .timer-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .timer-btn.small { padding: 10px; font-size: 14px; margin-top: 6px; }
        .timer-btn.go { background: #34a853; color: #fff; }
        .timer-btn.go:disabled { background: #ccc; color: #666; }
        .timer-btn.stop { background: #ff3b30; color: #fff; }
        .timer-btn.completed { background: #e0e0e0; color: #666; }
        .timer-btn:active:not(:disabled) { transform: scale(0.98); }
        .rest-overlay { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; align-items: center; padding: 24px; border-radius: 24px 24px 0 0; }
        .rest-overlay.show { display: flex; }
        .rest-top-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 12px; }
        .rest-title { font-size: 18px; font-weight: 600; color: #fff; }
        .rest-timer { font-size: 48px; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
        .rest-next { font-size: 14px; color: rgba(255, 255, 255, 0.6); margin-top: 8px; }
        .rest-next-exercise { font-size: 16px; color: #fff; font-weight: 600; }
        .rest-skip { margin-top: 16px; padding: 12px 32px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 10px; color: #fff; font-size: 15px; font-weight: 600; cursor: pointer; }
        .history-section { padding: 16px; background: rgba(255, 255, 255, 0.05); border-radius: 0 0 24px 24px; }
        .history-title { color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 12px; }
        .history-content { font-size: 13px; color: rgba(255, 255, 255, 0.7); white-space: pre-line; line-height: 1.6; }
        .history-date { color: #fff; font-weight: 600; }
        .history-duration { color: rgba(255, 255, 255, 0.5); font-size: 12px; }
        .history-edit-icon { color: rgba(255, 255, 255, 0.4); font-size: 11px; margin-left: 8px; cursor: pointer; }
        .history-edit-icon:hover { color: rgba(255, 255, 255, 0.7); }
        .history-edit-container { display: none; margin: 8px 0; }
        .history-edit-container.show { display: block; }
        .history-edit-textarea { width: 100%; min-height: 100px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff; font-family: monospace; font-size: 12px; padding: 10px; resize: vertical; }
        .history-edit-textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.4); }
        .history-edit-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .history-edit-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .history-edit-btn.save { background: #34a853; color: #fff; }
        .history-edit-btn.cancel { background: rgba(255, 255, 255, 0.1); color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Josh's Simple Gains</h1>
            <p>Target: 40-70 seconds per set</p>
            <a href="settings.html">⚙️ Settings</a>
        </div>
        <div class="workout-selector" id="workoutSelector"></div>
        <div class="metrics-section" id="metricsSection"></div>
        <div class="content" id="workoutContent"></div>
        <div class="history-section">
            <div class="history-title">History</div>
            <div class="history-content" id="historyContent"></div>
        </div>
    </div>
    <div class="rest-overlay" id="restOverlay">
        <div class="rest-top-row">
            <div class="rest-title" id="restTitle">Rest</div>
            <div class="rest-timer" id="restTimer">90</div>
        </div>
        <div class="rest-next">Up next:</div>
        <div class="rest-next-exercise" id="restNextExercise">—</div>
        <button class="rest-skip" onclick="skipRest()">Skip</button>
    </div>
    <script type="module">
        import { initWorkoutData, saveWorkoutData } from './workoutData.js';
        
        var workoutHistoryData = [];  // Loaded from GitHub
        var workoutDurationsData = {}; // Loaded from GitHub
        
        var workouts = {
            A: { name: "Day A", label: "Mon", exercises: [
                { name: "Incline Press", increment: 2.5 },
                { name: "Chest-Supported Row", increment: 2.5 },
                { name: "Pullover", increment: 2.5 },
                { name: "Trap Bar Dead-Shrug", increment: 5 },
                { name: "Lateral Raise", increment: 2.5 }
            ]},
            B: { name: "Day B", label: "Wed", exercises: [
                { name: "Overhead Press", increment: 2.5 },
                { name: "Single-Arm Row", increment: 2.5, unilateral: true },
                { name: "Pullover", increment: 2.5 },
                { name: "Goblet Squat", increment: 5 },
                { name: "Curl", increment: 2.5 }
            ]},
            C: { name: "Day C", label: "Fri", exercises: [
                { name: "Bench Press", increment: 2.5 },
                { name: "Pullover", increment: 2.5 },
                { name: "Skull Crusher", increment: 2.5 },
                { name: "Reverse Fly", increment: 2.5 },
                { name: "DB Romanian Deadlift", increment: 2.5 }
            ]}
        };
        var currentWorkout = "A";
        var timers = {};
        var restInterval = null;
        var audioContext = null;
        var workoutStartTime = null;

        // Progression flags stored in localStorage
        function getProgressionFlags() {
            return JSON.parse(localStorage.getItem("progressionFlags") || "{}");
        }
        function setProgressionFlag(exerciseKey, value) {
            var flags = getProgressionFlags();
            flags[exerciseKey] = value;
            localStorage.setItem("progressionFlags", JSON.stringify(flags));
        }
        function clearProgressionFlag(exerciseKey) {
            var flags = getProgressionFlags();
            delete flags[exerciseKey];
            localStorage.setItem("progressionFlags", JSON.stringify(flags));
        }

        function getAudioContext() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            return audioContext;
        }
        function playBeep(freq, duration) {
            try {
                var ctx = getAudioContext();
                var osc = ctx.createOscillator();
                var gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = freq;
                gain.gain.value = 0.3;
                osc.start();
                osc.stop(ctx.currentTime + duration);
            } catch (e) {}
        }

        function isNullSet(time) {
            return time < 10;
        }

        // Combined TUT progression logic
        function evaluateProgression(exerciseName, workoutKey, lastEntry, exercise) {
            var exerciseKey = workoutKey + "_" + exerciseName;
            var flags = getProgressionFlags();
            var hasPendingFlag = flags[exerciseKey] === true;

            if (!lastEntry) {
                return { action: 'maintain', combinedTUT: 0, hasPendingFlag: false };
            }

            var combinedTUT = 0;
            var validSets = 0;

            if (exercise.unilateral) {
                var times = [lastEntry.time1L, lastEntry.time1R, lastEntry.time2L, lastEntry.time2R];
                for (var i = 0; i < times.length; i++) {
                    if (!isNullSet(times[i])) {
                        combinedTUT += times[i];
                        validSets++;
                    }
                }
                if (validSets > 0 && validSets < 4) {
                    combinedTUT = Math.round(combinedTUT * (4 / validSets) / 2);
                } else if (validSets === 4) {
                    combinedTUT = Math.round(combinedTUT / 2);
                }
            } else {
                if (!isNullSet(lastEntry.time1)) {
                    combinedTUT += lastEntry.time1;
                    validSets++;
                }
                if (!isNullSet(lastEntry.time2)) {
                    combinedTUT += lastEntry.time2;
                    validSets++;
                }
                if (validSets === 1) {
                    return { action: 'maintain', combinedTUT: combinedTUT, hasPendingFlag: hasPendingFlag };
                }
            }

            if (combinedTUT > 140) {
                if (hasPendingFlag) {
                    return { action: 'increase', combinedTUT: combinedTUT, hasPendingFlag: true };
                } else {
                    return { action: 'pending', combinedTUT: combinedTUT, hasPendingFlag: false };
                }
            } else if (combinedTUT < 80) {
                return { action: 'deload', combinedTUT: combinedTUT, hasPendingFlag: false };
            } else {
                return { action: 'maintain', combinedTUT: combinedTUT, hasPendingFlag: hasPendingFlag };
            }
        }

        async function initApp() {
            // Load workout data from GitHub (or local cache)
            var data = await initWorkoutData();
            workoutHistoryData = data.workoutHistory || [];
            workoutDurationsData = data.workoutDurations || {};
            
            renderWorkoutSelector();
            loadWorkout(currentWorkout);
            renderMetrics();
            renderHistory();
        }
        
        function renderWorkoutSelector() {
            var selector = document.getElementById("workoutSelector");
            var html = "";
            for (var key in workouts) {
                var activeClass = key === currentWorkout ? "active" : "";
                html += "<button class=\"workout-btn " + activeClass + "\" onclick=\"loadWorkout('" + key + "')\">" + workouts[key].label + "<br>" + workouts[key].name + "</button>";
            }
            selector.innerHTML = html;
        }
        
        function loadWorkout(workoutKey) {
            currentWorkout = workoutKey;
            workoutStartTime = null;
            var workout = workouts[workoutKey];
            var content = document.getElementById("workoutContent");
            var history = workoutHistoryData;
            var today = new Date().toISOString().split("T")[0];
            var btns = document.querySelectorAll(".workout-btn");
            var keys = Object.keys(workouts);
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.toggle("active", keys[i] === workoutKey);
            }
            var html = "";
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                var exerciseKey = workoutKey + "_" + exercise.name;
                var lastEntry = null;
                var filtered = history.filter(function(h) { return h.exercise === exercise.name && h.workout === workoutKey && h.date !== today; });
                filtered.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
                if (filtered.length > 0) lastEntry = filtered[0];

                var progression = evaluateProgression(exercise.name, workoutKey, lastEntry, exercise);
                var suggestedWeight = lastEntry ? lastEntry.weight : "";
                var showReady = false;
                var showPending = false;
                var showDeload = false;

                if (lastEntry) {
                    if (progression.action === 'increase') {
                        suggestedWeight = lastEntry.weight + exercise.increment;
                        showReady = true;
                        clearProgressionFlag(exerciseKey);
                    } else if (progression.action === 'pending') {
                        suggestedWeight = lastEntry.weight;
                        showPending = true;
                        setProgressionFlag(exerciseKey, true);
                    } else if (progression.action === 'deload') {
                        suggestedWeight = Math.max(0, lastEntry.weight - exercise.increment);
                        showDeload = true;
                        clearProgressionFlag(exerciseKey);
                    } else {
                        suggestedWeight = lastEntry.weight;
                        clearProgressionFlag(exerciseKey);
                    }
                }

                var todayEntry = null;
                for (var j = 0; j < history.length; j++) {
                    if (history[j].exercise === exercise.name && history[j].workout === workoutKey && history[j].date === today) {
                        todayEntry = history[j];
                        break;
                    }
                }
                var isCompleted = todayEntry !== null;
                var cardClass = isCompleted ? "exercise-card completed" : "exercise-card";
                html += "<div class=\"" + cardClass + "\" id=\"card-" + idx + "\">";
                html += "<div class=\"exercise-header\"><span class=\"exercise-title\">" + exercise.name + "</span>";
                if (showReady && !isCompleted) html += "<span class=\"ready-badge\">Ready to increase</span>";
                if (showPending && !isCompleted) html += "<span class=\"pending-badge\">1 more to increase</span>";
                if (showDeload && !isCompleted) html += "<span class=\"deload-badge\">Deload</span>";
                html += "</div>";
                html += "<div class=\"weight-row\"><span class=\"weight-label\">Weight:</span>";
                html += "<input type=\"number\" class=\"weight-input\" id=\"weight-" + idx + "\" value=\"" + (todayEntry ? todayEntry.weight : suggestedWeight) + "\" step=\"" + exercise.increment + "\" oninput=\"onWeightInput(" + idx + ")\">";
                html += "<span class=\"weight-unit\">lb</span></div>";
                if (exercise.unilateral) {
                    html += renderUnilateralSets(idx, todayEntry);
                } else {
                    html += renderBilateralSets(idx, todayEntry);
                }
                html += "</div>";
            }
            content.innerHTML = html;
            updateAllButtons();
        }
        
        function renderBilateralSets(idx, todayEntry) {
            var t1 = todayEntry ? todayEntry.time1 : 0;
            var t2 = todayEntry ? todayEntry.time2 : 0;
            var html = "<div class=\"sets-container\">";
            html += "<div class=\"set-box\"><div class=\"set-label\">Set 1</div><div class=\"set-time\" id=\"time-" + idx + "-1\">" + t1 + "s</div></div>";
            html += "<div class=\"set-box\"><div class=\"set-label\">Set 2</div><div class=\"set-time\" id=\"time-" + idx + "-2\">" + t2 + "s</div></div>";
            html += "</div>";
            if (todayEntry) {
                html += "<button class=\"timer-btn completed\" disabled>Completed</button>";
                html += "<button class=\"restart-btn show\" onclick=\"restartExercise(" + idx + ")\">Restart Exercise</button>";
            } else {
                html += "<button class=\"timer-btn go\" id=\"btn-" + idx + "-1\" onclick=\"handleTimer(" + idx + ", 1)\">Enter Weight</button>";
                html += "<button class=\"restart-btn\" id=\"restart-" + idx + "\"></button>";
            }
            return html;
        }
        
        function renderUnilateralSets(idx, todayEntry) {
            var t1L = todayEntry ? todayEntry.time1L : 0;
            var t1R = todayEntry ? todayEntry.time1R : 0;
            var t2L = todayEntry ? todayEntry.time2L : 0;
            var t2R = todayEntry ? todayEntry.time2R : 0;
            var html = "<div class=\"lr-container\">";
            html += "<div class=\"lr-box\"><div class=\"lr-label\">Set 1L</div><div class=\"set-time small\" id=\"time-" + idx + "-1L\">" + t1L + "s</div>";
            html += "<button class=\"timer-btn small go\" id=\"btn-" + idx + "-1L\" onclick=\"handleTimer(" + idx + ", '1L')\"" + (todayEntry ? " disabled" : "") + ">" + (todayEntry ? "Done" : "Enter Wt") + "</button></div>";
            html += "<div class=\"lr-box\"><div class=\"lr-label\">Set 1R</div><div class=\"set-time small\" id=\"time-" + idx + "-1R\">" + t1R + "s</div>";
            html += "<button class=\"timer-btn small go\" id=\"btn-" + idx + "-1R\" onclick=\"handleTimer(" + idx + ", '1R')\"" + (todayEntry ? " disabled" : "") + ">" + (todayEntry ? "Done" : "Enter Wt") + "</button></div>";
            html += "</div>";
            html += "<div class=\"lr-container\">";
            html += "<div class=\"lr-box\"><div class=\"lr-label\">Set 2L</div><div class=\"set-time small\" id=\"time-" + idx + "-2L\">" + t2L + "s</div>";
            html += "<button class=\"timer-btn small go\" id=\"btn-" + idx + "-2L\" onclick=\"handleTimer(" + idx +, '2L')\"" + (todayEntry ? " disabled" : "") + ">" + (todayEntry ? "Done" : "Enter Wt") + "</button></div>";
            html += "<div class=\"lr-box\"><div class=\"lr-label\">Set 2R</div><div class=\"set-time small\" id=\"time-" + idx + "-2R\">" + t2R + "s</div>";
            html += "<button class=\"timer-btn small go\" id=\"btn-" + idx + "-2R\" onclick=\"handleTimer(" + idx + ", '2R')\"" + (todayEntry ? " disabled" : "") + ">" + (todayEntry ? "Done" : "Enter Wt") + "</button></div>";
            html += "</div>";
            if (todayEntry) {
                html += "<button class=\"restart-btn show\" onclick=\"restartExercise(" + idx + ")\">Restart Exercise</button>";
            }
            return html;
        }

        function onWeightInput(exerciseIdx) {
            updateAllButtons();
        }

        function updateAllButtons() {
            var workout = workouts[currentWorkout];
            var hasActiveTimer = Object.keys(timers).length > 0;
            
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                if (exercise.unilateral) {
                    ['1L', '1R', '2L', '2R'].forEach(function(setId) {
                        updateButtonState(idx, setId, hasActiveTimer);
                    });
                } else {
                    updateButtonState(idx, 1, hasActiveTimer);
                    updateButtonState(idx, 2, hasActiveTimer);
                }
            }
        }

        function updateButtonState(exerciseIdx, setId, hasActiveTimer) {
            var btn = document.getElementById("btn-" + exerciseIdx + "-" + setId);
            if (!btn) return;
            
            var timerKey = exerciseIdx + "-" + setId;
            var isThisTimerActive = timers[timerKey] !== undefined;
            
            // Don't touch completed buttons or the currently running timer
            if (btn.classList.contains('completed') || isThisTimerActive) return;
            
            var weightInput = document.getElementById("weight-" + exerciseIdx);
            var hasWeight = weightInput && weightInput.value && parseFloat(weightInput.value) > 0;
            
            if (hasActiveTimer) {
                // Another timer is running - disable this button
                btn.disabled = true;
                btn.textContent = 'Wait...';
            } else {
                // No timer running - enable if has weight
                btn.disabled = !hasWeight;
                btn.textContent = hasWeight ? 'Go' : (typeof setId === 'string' ? 'Enter Wt' : 'Enter Weight');
            }
        }

        function handleTimer(idx, setId) {
            var timerKey = idx + "-" + setId;
            var btn = document.getElementById("btn-" + idx + "-" + setId);
            var timeEl = document.getElementById("time-" + idx + "-" + setId);
            
            if (!workoutStartTime) workoutStartTime = new Date();
            
            if (timers[timerKey]) {
                // Stop timer
                clearInterval(timers[timerKey].interval);
                var elapsed = Math.floor((Date.now() - timers[timerKey].start) / 1000);
                timeEl.textContent = elapsed + "s";
                timeEl.classList.remove("counting");
                timeEl.classList.remove("countdown");
                delete timers[timerKey];
                
                var exercise = workouts[currentWorkout].exercises[idx];
                var nextSet = getNextSet(setId, exercise.unilateral);
                
                if (nextSet) {
                    var restDuration = getRestDuration(setId, exercise.unilateral);
                    if (restDuration > 0) {
                        showRest(restDuration, idx, nextSet);
                    }
                } else {
                    saveExercise(idx);
                    var nextExerciseIdx = idx + 1;
                    if (nextExerciseIdx < workouts[currentWorkout].exercises.length) {
                        var nextExercise = workouts[currentWorkout].exercises[nextExerciseIdx];
                        var nextFirstSet = nextExercise.unilateral ? "1L" : 1;
                        showRest(90, nextExerciseIdx, nextFirstSet);
                    } else {
                        saveWorkoutDuration();
                    }
                }
                
                updateAllButtons();
            } else {
                // Start countdown
                startCountdown(idx, setId);
            }
        }

        function startCountdown(idx, setId) {
            var timeEl = document.getElementById("time-" + idx + "-" + setId);
            var btn = document.getElementById("btn-" + idx + "-" + setId);
            var exercise = workouts[currentWorkout].exercises[idx];
            
            var count = 5;
            timeEl.textContent = count;
            timeEl.classList.add("countdown");
            btn.textContent = "Ready...";
            btn.disabled = true;
            playBeep(0.1, 440);
            
            var countInterval = setInterval(function() {
                count--;
                if (count > 0) {
                    timeEl.textContent = count;
                    playBeep(0.1, 440);
                } else {
                    clearInterval(countInterval);
                    timeEl.classList.remove("countdown");
                    playBeep(0.3, 880);
                    startTimer(idx, setId);
                }
            }, 1000);
        }

        function startTimer(idx, setId) {
            var btn = document.getElementById("btn-" + idx + "-" + setId);
            var timeEl = document.getElementById("time-" + idx + "-" + setId);
            var timerKey = idx + "-" + setId;
            
            timers[timerKey] = { start: Date.now(), interval: null };
            timeEl.classList.add("counting");
            btn.textContent = "Stop";
            btn.className = btn.className.replace('go', 'stop');
            btn.disabled = false;
            
            var beeped70 = false;
            timers[timerKey].interval = setInterval(function() {
                var elapsed = Math.floor((Date.now() - timers[timerKey].start) / 1000);
                timeEl.textContent = elapsed + "s";
                
                if (elapsed >= 70 && !beeped70) {
                    beeped70 = true;
                    timeEl.classList.add("success");
                    playBeep(0.2, 1000);
                    setTimeout(function() { playBeep(0.2, 1000); }, 200);
                    setTimeout(function() { playBeep(0.2, 1000); }, 400);
                }
            }, 100);
            
            updateAllButtons();
        }

        function getNextSet(currentSet, isUnilateral) {
            if (isUnilateral) {
                var order = ["1L", "1R", "2L", "2R"];
                var currentIndex = order.indexOf(currentSet);
                return currentIndex < order.length - 1 ? order[currentIndex + 1] : null;
            } else {
                return currentSet === 1 ? 2 : null;
            }
        }

        function getRestDuration(currentSet, isUnilateral) {
            if (isUnilateral) {
                if (currentSet === "1L") return 0;
                if (currentSet === "1R") return 60;
                if (currentSet === "2L") return 0;
                return 90;
            } else {
                return currentSet === 1 ? 60 : 90;
            }
        }

        function showRest(duration, nextIdx, nextSet) {
            var overlay = document.getElementById("restOverlay");
            var timerEl = document.getElementById("restTimer");
            var titleEl = document.getElementById("restTitle");
            var nextExerciseEl = document.getElementById("restNextExercise");
            var remaining = duration;
            
            timerEl.textContent = remaining;
            titleEl.textContent = "Rest";
            
            var currentExercise = workouts[currentWorkout].exercises[nextIdx];
            if (duration === 90 && nextIdx < workouts[currentWorkout].exercises.length) {
                nextExerciseEl.textContent = currentExercise.name;
            } else {
                nextExerciseEl.textContent = currentExercise.name + " - Set " + nextSet;
            }
            
            overlay.classList.add("show");
            
            restInterval = setInterval(function() {
                remaining--;
                timerEl.textContent = remaining;
                if (remaining <= 0) {
                    clearInterval(restInterval);
                    overlay.classList.remove("show");
                    // Manual start - no auto-start here
                }
            }, 1000);
        }

        function skipRest() {
            if (restInterval) {
                clearInterval(restInterval);
                restInterval = null;
            }
            document.getElementById("restOverlay").classList.remove("show");
            // Manual start - no auto-start here
        }

        function saveExercise(idx) {
            var exercise = workouts[currentWorkout].exercises[idx];
            var weight = parseFloat(document.getElementById("weight-" + idx).value) || 0;
            var today = new Date().toISOString().split("T")[0];
            var history = workoutHistoryData;
            var entry = { date: today, workout: currentWorkout, exercise: exercise.name, weight: weight };
            
            if (exercise.unilateral) {
                entry.time1L = parseInt(document.getElementById("time-" + idx + "-1L").textContent) || 0;
                entry.time1R = parseInt(document.getElementById("time-" + idx + "-1R").textContent) || 0;
                entry.time2L = parseInt(document.getElementById("time-" + idx + "-2L").textContent) || 0;
                entry.time2R = parseInt(document.getElementById("time-" + idx + "-2R").textContent) || 0;
                entry.unilateral = true;
            } else {
                entry.time1 = parseInt(document.getElementById("time-" + idx + "-1").textContent) || 0;
                entry.time2 = parseInt(document.getElementById("time-" + idx + "-2").textContent) || 0;
            }
            
            var existingIndex = -1;
            for (var i = 0; i < history.length; i++) {
                if (history[i].date === today && history[i].exercise === exercise.name && history[i].workout === currentWorkout) {
                    existingIndex = i;
                    break;
                }
            }
            if (existingIndex >= 0) history[existingIndex] = entry;
            else history.push(entry);
            
            workoutHistoryData = history;
            saveWorkoutDataToGitHub();
            
            renderMetrics();
            renderHistory();
            document.getElementById("card-" + idx).classList.add("completed");
        }

        function saveWorkoutDuration() {
            if (!workoutStartTime) return;
            var duration = Math.round((new Date() - workoutStartTime) / 60000);
            var today = new Date().toISOString().split("T")[0];
            var durations = workoutDurationsData;
            durations[today + "-" + currentWorkout] = duration;
            workoutDurationsData = durations;
            saveWorkoutDataToGitHub();
            renderHistory();
        }

        function restartExercise(idx) {
            var exercise = workouts[currentWorkout].exercises[idx];
            var today = new Date().toISOString().split("T")[0];
            var history = workoutHistoryData;
            
            history = history.filter(function(h) {
                return !(h.exercise === exercise.name && h.workout === currentWorkout && h.date === today);
            });
            workoutHistoryData = history;
            saveWorkoutDataToGitHub();
            
            loadWorkout(currentWorkout);
        }

        function renderMetrics() {
            var metricsSection = document.getElementById("metricsSection");
            var history = workoutHistoryData;
            
            var now = new Date();
            var fourWeeksAgo = new Date(now.getTime() - 28 * 24 * 60 * 60 * 1000);
            var eightWeeksAgo = new Date(now.getTime() - 56 * 24 * 60 * 60 * 1000);
            
            var recentDates = {};
            for (var i = 0; i < history.length; i++) {
                var entryDate = new Date(history[i].date + "T12:00:00");
                var dateKey = history[i].date + "-" + history[i].workout;
                if (entryDate >= fourWeeksAgo) {
                    recentDates[dateKey] = true;
                }
            }
            var sessionsLast4Weeks = Object.keys(recentDates).length;
            
            var workout = workouts[currentWorkout];
            var exerciseChanges = [];
            var totalCurrentWeight = 0;
            var totalOldWeight = 0;
            var hasOldData = false;
            
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                
                var recentEntries = history.filter(function(h) {
                    var d = new Date(h.date + "T12:00:00");
                    return h.exercise === exercise.name && h.workout === currentWorkout && d >= fourWeeksAgo;
                });
                recentEntries.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
                
                var olderEntries = history.filter(function(h) {
                    var d = new Date(h.date + "T12:00:00");
                    return h.exercise === exercise.name && h.workout === currentWorkout && d >= eightWeeksAgo && d < fourWeeksAgo;
                });
                olderEntries.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
                
                var currentWeight = recentEntries.length > 0 ? recentEntries[0].weight : null;
                var oldWeight = olderEntries.length > 0 ? olderEntries[0].weight : null;
                
                if (currentWeight !== null) {
                    totalCurrentWeight += currentWeight;
                }
                if (oldWeight !== null) {
                    totalOldWeight += oldWeight;
                    hasOldData = true;
                }
                
                var change = null;
                if (currentWeight !== null && oldWeight !== null) {
                    change = currentWeight - oldWeight;
                }
                
                exerciseChanges.push({
                    name: exercise.name,
                    current: currentWeight,
                    old: oldWeight,
                    change: change
                });
            }
            
            var totalPctChange = null;
            if (hasOldData && totalOldWeight > 0) {
                totalPctChange = ((totalCurrentWeight - totalOldWeight) / totalOldWeight * 100).toFixed(1);
            }
            
            var html = "<div class=\"metrics-title\">Rolling 4 Weeks <span>vs prior 4 weeks</span></div>";
            html += "<div class=\"metrics-grid\">";
            
            var sessionsClass = sessionsLast4Weeks >= 10 ? "positive" : (sessionsLast4Weeks >= 6 ? "neutral" : "negative");
            html += "<div class=\"metric-card\"><div class=\"metric-value " + sessionsClass + "\">" + sessionsLast4Weeks + "/12</div><div class=\"metric-label\">Sessions</div></div>";
            
            var loadClass = "neutral";
            var loadDisplay = "—";
            if (totalPctChange !== null) {
                loadClass = parseFloat(totalPctChange) > 0 ? "positive" : (parseFloat(totalPctChange) < 0 ? "negative" : "neutral");
                loadDisplay = (parseFloat(totalPctChange) > 0 ? "+" : "") + totalPctChange + "%";
            }
            html += "<div class=\"metric-card\"><div class=\"metric-value " + loadClass + "\">" + loadDisplay + "</div><div class=\"metric-label\">Total Load</div></div>";
            
            html += "<div class=\"metric-card\"><div class=\"metric-value\">" + totalCurrentWeight + "</div><div class=\"metric-label\">Total lbs</div></div>";
            
            html += "</div>";
            
            html += "<div class=\"exercise-changes\">";
            for (var i = 0; i < exerciseChanges.length; i++) {
                var ex = exerciseChanges[i];
                var changeText = "—";
                var changeClass = "same";
                if (ex.change !== null) {
                    if (ex.change > 0) {
                        changeText = "+" + ex.change + "lb";
                        changeClass = "up";
                    } else if (ex.change < 0) {
                        changeText = ex.change + "lb";
                        changeClass = "down";
                    } else {
                        changeText = "0";
                        changeClass = "same";
                    }
                } else if (ex.current !== null) {
                    changeText = ex.current + "lb";
                    changeClass = "same";
                }
                html += "<div class=\"exercise-change\"><span class=\"exercise-change-name\">" + ex.name + "</span><span class=\"exercise-change-value " + changeClass + "\">" + changeText + "</span></div>";
            }
            html += "</div>";
            
            metricsSection.innerHTML = html;
        }

        function renderHistory() {
            var historyContent = document.getElementById("historyContent");
            var history = workoutHistoryData;
            var durations = workoutDurationsData;
            
            if (history.length === 0) {
                historyContent.innerHTML = "No history yet";
                return;
            }
            
            var byDate = {};
            for (var i = 0; i < history.length; i++) {
                var entry = history[i];
                var key = entry.date + "-" + entry.workout;
                if (!byDate[key]) byDate[key] = [];
                byDate[key].push(entry);
            }
            
            var keys = Object.keys(byDate).sort().reverse();
            var html = "";
            
            for (var i = 0; i < Math.min(keys.length, 10); i++) {
                var key = keys[i];
                var parts = key.split("-");
                var date = parts.slice(0, 3).join("-");
                var workout = parts[3];
                var dateObj = new Date(date + "T12:00:00");
                var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                var dateStr = months[dateObj.getMonth()] + " " + dateObj.getDate();
                var durationKey = key;
                var durationStr = durations[durationKey] ? " <span class=\"history-duration\">(" + durations[durationKey] + " min)</span>" : "";
                
                html += "<span class=\"history-date\">" + dateStr + "</span>" + durationStr;
                html += "<span class=\"history-edit-icon\" onclick=\"toggleHistoryEdit('" + key + "')\">✏️</span>\n";
                
                var editText = "";
                for (var j = 0; j < byDate[key].length; j++) {
                    var entry = byDate[key][j];
                    if (entry.unilateral) {
                        html += entry.exercise + ": " + entry.weight + "lb → " + entry.time1L + "s, " + entry.time1R + "s, " + entry.time2L + "s, " + entry.time2R + "s\n";
                        editText += entry.exercise + ": " + entry.weight + "lb → " + entry.time1L + "s, " + entry.time1R + "s, " + entry.time2L + "s, " + entry.time2R + "s\n";
                    } else {
                        html += entry.exercise + ": " + entry.weight + "lb → " + entry.time1 + "s, " + entry.time2 + "s\n";
                        editText += entry.exercise + ": " + entry.weight + "lb → " + entry.time1 + "s, " + entry.time2 + "s\n";
                    }
                }
                
                html += "<div class=\"history-edit-container\" id=\"edit-" + key + "\">";
                html += "<textarea class=\"history-edit-textarea\" id=\"textarea-" + key + "\">" + editText.trim() + "</textarea>";
                html += "<div class=\"history-edit-buttons\">";
                html += "<button class=\"history-edit-btn cancel\" onclick=\"toggleHistoryEdit('" + key + "')\">Cancel</button>";
                html += "<button class=\"history-edit-btn save\" onclick=\"saveHistoryEdit('" + key + "')\">Save</button>";
                html += "</div></div>";
                
                if (i < keys.length - 1) html += "\n";
            }
            
            historyContent.innerHTML = html || "No history yet";
        }

        window.toggleHistoryEdit = function(key) {
            var container = document.getElementById("edit-" + key);
            if (container) {
                container.classList.toggle("show");
            }
        };

        window.saveHistoryEdit = function(key) {
            var textarea = document.getElementById("textarea-" + key);
            var text = textarea.value.trim();
            var lines = text.split("\n");
            
            var parts = key.split("-");
            var date = parts.slice(0, 3).join("-");
            var workout = parts[3];
            
            var history = workoutHistoryData;
            
            history = history.filter(function(h) {
                return !(h.date === date && h.workout === workout);
            });
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                var match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)lb\s*->\s*(.+)$/);
                if (!match) continue;
                
                var exerciseName = match[1].trim();
                var weight = parseFloat(match[2]);
                var timesStr = match[3];
                var times = timesStr.split(",").map(function(t) { return parseInt(t.trim()) || 0; });
                
                var entry = {
                    date: date,
                    workout: workout,
                    exercise: exerciseName,
                    weight: weight
                };
                
                if (times.length === 4) {
                    entry.time1L = times[0];
                    entry.time1R = times[1];
                    entry.time2L = times[2];
                    entry.time2R = times[3];
                    entry.unilateral = true;
                } else if (times.length >= 2) {
                    entry.time1 = times[0];
                    entry.time2 = times[1];
                }
                
                history.push(entry);
            }
            
            workoutHistoryData = history;
            saveWorkoutDataToGitHub();
            
            toggleHistoryEdit(key);
            renderMetrics();
            renderHistory();
            loadWorkout(currentWorkout);
        };

        window.loadWorkout = loadWorkout;
        window.handleTimer = handleTimer;
        window.skipRest = skipRest;
        window.restartExercise = restartExercise;
        window.onWeightInput = onWeightInput;

        // Helper to save workout data to GitHub in the background
        function saveWorkoutDataToGitHub() {
            saveWorkoutData({
                workoutHistory: workoutHistoryData,
                workoutDurations: workoutDurationsData
            }).catch(function(err) {
                console.error('GitHub sync failed:', err);
                // Data is still saved locally, will retry on next save
            });
        }

        if (document.readyState === "loading") { 
            document.addEventListener("DOMContentLoaded", initApp); 
        } else { 
            initApp(); 
        }
    </script>
</body>
</html>
