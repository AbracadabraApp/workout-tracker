```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Josh's Simple Gains</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: #000; min-height: 100vh; padding: 16px; color: #fff; }
        .container { max-width: 480px; margin: 0 auto; background: linear-gradient(145deg, #1d1d1f 0%, #121212 100%); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%); color: #fff; padding: 28px 24px 24px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .header h1 { font-size: 24px; font-weight: 600; letter-spacing: -0.5px; }
        .workout-selector { display: flex; background: rgba(255, 255, 255, 0.08); padding: 8px; gap: 6px; }
        .workout-btn { flex: 1; padding: 14px 10px; border: none; background: transparent; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; }
        .workout-btn.active { background: rgba(255, 255, 255, 0.12); color: #fff; }
        .content { padding: 16px; }
        .exercise-card { background: #fff; border-radius: 16px; padding: 18px; margin-bottom: 12px; color: #1d1d1f; }
        .exercise-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .exercise-title { font-size: 22px; font-weight: 600; color: #1d1d1f; }
        .ready-badge { background: linear-gradient(135deg, #34a853 0%, #2d9648 100%); color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .maintain-badge { background: linear-gradient(135deg, #ff9500 0%, #f57c00 100%); color: #fff; padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .weight-row { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
        .weight-label { font-size: 15px; font-weight: 500; color: rgba(60, 60, 67, 0.8); }
        .weight-input { width: 80px; padding: 10px; border: 1.5px solid rgba(0, 0, 0, 0.12); background: #fff; border-radius: 8px; font-size: 17px; font-weight: 600; color: #1d1d1f; text-align: center; }
        .weight-input::placeholder { color: rgba(60, 60, 67, 0.4); font-weight: 400; }
        .weight-input:focus { outline: none; border-color: #1d1d1f; }
        .sets-container { display: flex; gap: 12px; }
        .set-box { flex: 1; background: #f5f5f7; border-radius: 12px; padding: 14px; text-align: center; }
        .set-label { font-size: 13px; font-weight: 600; color: rgba(60, 60, 67, 0.6); margin-bottom: 10px; }
        .set-row { margin-bottom: 14px; }
        .set-row-label { font-size: 14px; font-weight: 600; color: rgba(60, 60, 67, 0.7); margin-bottom: 8px; }
        .lr-container { display: flex; gap: 8px; }
        .lr-box { flex: 1; background: #f5f5f7; border-radius: 10px; padding: 12px 8px; text-align: center; }
        .lr-label { font-size: 11px; font-weight: 600; color: rgba(60, 60, 67, 0.5); margin-bottom: 6px; text-transform: uppercase; }
        .timer-display { font-size: 42px; font-weight: 700; font-variant-numeric: tabular-nums; margin-bottom: 10px; color: #1d1d1f; }
        .timer-display.small { font-size: 32px; }
        .timer-display.countdown { color: #ff9500; }
        .timer-display.success { color: #34a853; }
        .timer-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .timer-btn.small { padding: 10px; font-size: 14px; }
        .timer-btn.go { background: #34a853; color: #fff; }
        .timer-btn.go:disabled { background: #ccc; color: #666; }
        .timer-btn.stop { background: #ff3b30; color: #fff; }
        .timer-btn.completed { background: #e0e0e0; color: #666; }
        .timer-btn:active:not(:disabled) { transform: scale(0.98); }
        .rest-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .rest-overlay.show { display: flex; }
        .rest-title { font-size: 24px; font-weight: 600; color: #fff; margin-bottom: 20px; }
        .rest-timer { font-size: 72px; font-weight: 700; color: #fff; font-variant-numeric: tabular-nums; }
        .rest-skip { margin-top: 40px; padding: 16px 48px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 12px; color: #fff; font-size: 17px; font-weight: 600; cursor: pointer; }
        .footer-nav { background: rgba(255, 255, 255, 0.05); border-top: 1px solid rgba(255, 255, 255, 0.08); padding: 16px; display: flex; justify-content: center; gap: 32px; }
        .footer-nav a { color: rgba(255, 255, 255, 0.6); text-decoration: none; font-size: 14px; font-weight: 500; transition: color 0.2s; }
        .footer-nav a:hover, .footer-nav a.active { color: #fff; }
        .data-section { display: none; padding: 16px; background: rgba(255, 255, 255, 0.05); border-top: 1px solid rgba(255, 255, 255, 0.08); }
        .data-section.show { display: block; }
        .history-title { color: #fff; font-size: 16px; font-weight: 600; margin-bottom: 12px; }
        .history-content { font-size: 13px; color: rgba(255, 255, 255, 0.7); white-space: pre-line; line-height: 1.6; }
        .history-date { color: #fff; font-weight: 600; }
        .history-duration { color: rgba(255, 255, 255, 0.5); font-size: 12px; }
        .history-edit-icon { color: rgba(255, 255, 255, 0.4); font-size: 11px; margin-left: 8px; cursor: pointer; }
        .history-edit-icon:hover { color: rgba(255, 255, 255, 0.7); }
        .history-edit-container { display: none; margin: 8px 0; }
        .history-edit-container.show { display: block; }
        .history-edit-textarea { width: 100%; min-height: 100px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff; font-family: monospace; font-size: 12px; padding: 10px; resize: vertical; }
        .history-edit-textarea:focus { outline: none; border-color: rgba(255, 255, 255, 0.4); }
        .history-edit-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .history-edit-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .history-edit-btn.save { background: #34a853; color: #fff; }
        .history-edit-btn.cancel { background: rgba(255, 255, 255, 0.1); color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Josh's Simple Gains</h1>
        </div>
        <div class="workout-selector" id="workoutSelector"></div>
        <div class="content" id="workoutContent"></div>
        <div class="data-section" id="dataSection">
            <div class="history-title">History</div>
            <div class="history-content" id="historyContent"></div>
        </div>
        <div class="footer-nav">
            <a href="gains.html">Gains</a>
            <a href="#" id="dataToggle" class="active">Data</a>
            <a href="settings.html">Settings</a>
        </div>
    </div>
    <div class="rest-overlay" id="restOverlay">
        <div class="rest-title" id="restTitle">Rest</div>
        <div class="rest-timer" id="restTimer">90</div>
        <button class="rest-skip" onclick="skipRest()">Skip</button>
    </div>
    <script type="module">
        import { initWorkoutData, saveWorkoutData } from './workoutData.js';
        
        var workoutHistoryData = [];
        var workoutDurationsData = {};
        
        var workouts = {
            A: { name: "Day A", label: "Mon", exercises: [
                { name: "Incline Press", increment: 2.5 },
                { name: "Chest-Supported Row", increment: 2.5 },
                { name: "Pullover", increment: 2.5 },
                { name: "Trap Bar Dead-Shrug", increment: 5 },
                { name: "Lateral Raise", increment: 2.5 }
            ]},
            B: { name: "Day B", label: "Wed", exercises: [
                { name: "Overhead Press", increment: 2.5 },
                { name: "Single-Arm Row", increment: 2.5, unilateral: true },
                { name: "Pullover", increment: 2.5 },
                { name: "Goblet Squat", increment: 5 },
                { name: "Curl", increment: 2.5 }
            ]},
            C: { name: "Day C", label: "Fri", exercises: [
                { name: "Bench Press", increment: 2.5 },
                { name: "Pullover", increment: 2.5 },
                { name: "Skull Crusher", increment: 2.5 },
                { name: "Reverse Fly", increment: 2.5 },
                { name: "DB Romanian Deadlift", increment: 2.5 }
            ]}
        };
        var currentWorkout = "A";
        var timers = {};
        var restInterval = null;
        var audioContext = null;
        var workoutStartTime = null;
        var pendingAutoStart = null;
        var dataExpanded = false;
        
        function getAudioContext() {
            if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            if (audioContext.state === "suspended") { audioContext.resume(); }
            return audioContext;
        }
        function beep(frequency, duration, count) {
            if (count === undefined) count = 1;
            var ctx = getAudioContext();
            for (var i = 0; i < count; i++) {
                setTimeout(function() {
                    var oscillator = ctx.createOscillator();
                    var gainNode = ctx.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    oscillator.frequency.value = frequency;
                    oscillator.type = "sine";
                    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration / 1000);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + duration / 1000);
                }, i * 200);
            }
        }

        async function initApp() {
            var data = await initWorkoutData();
            workoutHistoryData = data.workoutHistory || [];
            workoutDurationsData = data.workoutDurations || {};
            
            renderWorkoutSelector();
            loadWorkout(currentWorkout);
            document.body.addEventListener("touchstart", function() { getAudioContext(); }, { once: true });
            document.body.addEventListener("click", function() { getAudioContext(); }, { once: true });
            
            // Data toggle handler
            document.getElementById("dataToggle").addEventListener("click", function(e) {
                e.preventDefault();
                dataExpanded = !dataExpanded;
                document.getElementById("dataSection").classList.toggle("show", dataExpanded);
                this.classList.toggle("active", dataExpanded);
            });
        }
        
        function renderWorkoutSelector() {
            var selector = document.getElementById("workoutSelector");
            var html = "";
            for (var key in workouts) {
                var activeClass = (key === currentWorkout) ? "active" : "";
                html += "<button class=\"workout-btn " + activeClass + "\" onclick=\"loadWorkout('" + key + "')\">" + workouts[key].label + "<br>" + workouts[key].name + "</button>";
            }
            selector.innerHTML = html;
        }
        
        function loadWorkout(workoutKey) {
            currentWorkout = workoutKey;
            dataExpanded = false;
            document.getElementById("dataSection").classList.remove("show");
            document.getElementById("dataToggle").classList.remove("active");
            
            var workout = workouts[workoutKey];
            var content = document.getElementById("workoutContent");
            var history = workoutHistoryData;
            var today = new Date().toISOString().split("T")[0];
            var btns = document.querySelectorAll(".workout-btn");
            var keys = Object.keys(workouts);
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.toggle("active", keys[i] === workoutKey);
            }
            var html = "";
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                var lastEntry = null;
                var filtered = history.filter(function(h) { 
                    return h.exercise === exercise.name && h.workout === workoutKey && h.date !== today; 
                });
                filtered.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
                if (filtered.length > 0) lastEntry = filtered[0];
                var suggestedWeight = "";
                var showNewWeight = false;
                var showMaintain = false;
                if (lastEntry) {
                    var combinedTUT = 0;
                    if (exercise.unilateral) {
                        combinedTUT = (lastEntry.time1L + lastEntry.time1R + lastEntry.time2L + lastEntry.time2R) / 2;
                    } else {
                        combinedTUT = lastEntry.time1 + lastEntry.time2;
                    }
                    
                    if (combinedTUT > 140) {
                        suggestedWeight = lastEntry.weight + exercise.increment;
                        showNewWeight = true;
                    } else {
                        suggestedWeight = lastEntry.weight;
                        showMaintain = true;
                    }
                }
                var todayEntry = history.find(function(h) { 
                    return h.exercise === exercise.name && h.workout === workoutKey && h.date === today; 
                });
                if (exercise.unilateral) {
                    html += renderUnilateralExercise(exercise, idx, suggestedWeight, showNewWeight, showMaintain, todayEntry);
                } else {
                    html += renderBilateralExercise(exercise, idx, suggestedWeight, showNewWeight, showMaintain, todayEntry);
                }
            }
            content.innerHTML = html;
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                if (exercise.unilateral) {
                    updateGoButton(idx, "1L"); updateGoButton(idx, "1R"); updateGoButton(idx, "2L"); updateGoButton(idx, "2R");
                } else {
                    updateGoButton(idx, 1); updateGoButton(idx, 2);
                }
            }
            renderHistory();
        }
        
        function renderBilateralExercise(exercise, idx, suggestedWeight, showNewWeight, showMaintain, todayEntry) {
            var badge = "";
            if (showNewWeight && !todayEntry) {
                badge = "<div class=\"ready-badge\">New Weight</div>";
            } else if (showMaintain && !todayEntry) {
                badge = "<div class=\"maintain-badge\">Maintain Weight</div>";
            }
            var weightVal = todayEntry ? todayEntry.weight : suggestedWeight;
            var disabled = todayEntry ? "disabled" : "";
            var btnClass = todayEntry ? "completed" : "go";
            var btn1Text = todayEntry ? "Completed" : "Enter Weight";
            var btn2Text = todayEntry ? "Completed" : "Enter Weight";
            var time1 = todayEntry ? formatTime(todayEntry.time1) : "00:00";
            var time2 = todayEntry ? formatTime(todayEntry.time2) : "00:00";
            var btn2Disabled = todayEntry ? "disabled" : "disabled";
            return "<div class=\"exercise-card\" id=\"card-" + idx + "\">" +
                "<div class=\"exercise-header\"><div class=\"exercise-title\">" + exercise.name + "</div>" + badge + "</div>" +
                "<div class=\"weight-row\"><span class=\"weight-label\">Weight:</span><input type=\"number\" class=\"weight-input\" id=\"weight-" + idx + "\" placeholder=\"lbs\" value=\"" + weightVal + "\" oninput=\"onWeightInput(" + idx + ")\" " + disabled + "></div>" +
                "<div class=\"sets-container\">" +
                "<div class=\"set-box\"><div class=\"set-label\">Set 1</div><div class=\"timer-display\" id=\"timer-" + idx + "-1\">" + time1 + "</div><button class=\"timer-btn " + btnClass + "\" id=\"btn-" + idx + "-1\" onclick=\"handleTimer(" + idx + ", 1)\" " + disabled + ">" + btn1Text + "</button></div>" +
                "<div class=\"set-box\"><div class=\"set-label\">Set 2</div><div class=\"timer-display\" id=\"timer-" + idx + "-2\">" + time2 + "</div><button class=\"timer-btn " + btnClass + "\" id=\"btn-" + idx + "-2\" onclick=\"handleTimer(" + idx + ", 2)\" " + btn2Disabled + ">" + btn2Text + "</button></div>" +
                "</div></div>";
        }
        
        function renderUnilateralExercise(exercise, idx, suggestedWeight, showNewWeight, showMaintain, todayEntry) {
            var badge = "";
            if (showNewWeight && !todayEntry) {
                badge = "<div class=\"ready-badge\">New Weight</div>";
            } else if (showMaintain && !todayEntry) {
                badge = "<div class=\"maintain-badge\">Maintain Weight</div>";
            }
            var weightVal = todayEntry ? todayEntry.weight : suggestedWeight;
            var disabled = todayEntry ? "disabled" : "";
            var btnClass = todayEntry ? "completed" : "go";
            var btnText = todayEntry ? "Done" : "Enter Wt";
            var t1L = todayEntry ? formatTime(todayEntry.time1L) : "00:00";
            var t1R = todayEntry ? formatTime(todayEntry.time1R) : "00:00";
            var t2L = todayEntry ? formatTime(todayEntry.time2L) : "00:00";
            var t2R = todayEntry ? formatTime(todayEntry.time2R) : "00:00";
            var btn1RDisabled = todayEntry ? "disabled" : "disabled";
            var btn2LDisabled = todayEntry ? "disabled" : "disabled";
            var btn2RDisabled = todayEntry ? "disabled" : "disabled";
            return "<div class=\"exercise-card\" id=\"card-" + idx + "\" data-unilateral=\"true\">" +
                "<div class=\"exercise-header\"><div class=\"exercise-title\">" + exercise.name + "</div>" + badge + "</div>" +
                "<div class=\"weight-row\"><span class=\"weight-label\">Weight:</span><input type=\"number\" class=\"weight-input\" id=\"weight-" + idx + "\" placeholder=\"lbs\" value=\"" + weightVal + "\" oninput=\"onWeightInput(" + idx + ")\" " + disabled + "></div>" +
                "<div class=\"set-row\"><div class=\"set-row-label\">Set 1</div><div class=\"lr-container\">" +
                "<div class=\"lr-box\"><div class=\"lr-label\">Left</div><div class=\"timer-display small\" id=\"timer-" + idx + "-1L\">" + t1L + "</div><button class=\"timer-btn small " + btnClass + "\" id=\"btn-" + idx + "-1L\" onclick=\"handleTimer(" + idx + ", '1L')\" " + disabled + ">" + btnText + "</button></div>" +
                "<div class=\"lr-box\"><div class=\"lr-label\">Right</div><div class=\"timer-display small\" id=\"timer-" + idx + "-1R\">" + t1R + "</div><button class=\"timer-btn small " + btnClass + "\" id=\"btn-" + idx + "-1R\" onclick=\"handleTimer(" + idx + ", '1R')\" " + btn1RDisabled + ">" + btnText + "</button></div>" +
                "</div></div>" +
                "<div class=\"set-row\"><div class=\"set-row-label\">Set 2</div><div class=\"lr-container\">" +
                "<div class=\"lr-box\"><div class=\"lr-label\">Left</div><div class=\"timer-display small\" id=\"timer-" + idx + "-2L\">" + t2L + "</div><button class=\"timer-btn small " + btnClass + "\" id=\"btn-" + idx + "-2L\" onclick=\"handleTimer(" + idx + ", '2L')\" " + btn2LDisabled + ">" + btnText + "</button></div>" +
                "<div class=\"lr-box\"><div class=\"lr-label\">Right</div><div class=\"timer-display small\" id=\"timer-" + idx + "-2R\">" + t2R + "</div><button class=\"timer-btn small " + btnClass + "\" id=\"btn-" + idx + "-2R\" onclick=\"handleTimer(" + idx + ", '2R')\" " + btn2RDisabled + ">" + btnText + "</button></div>" +
                "</div></div></div>";
        }
        
        function onWeightInput(exerciseIdx) {
            var workout = workouts[currentWorkout];
            var exercise = workout.exercises[exerciseIdx];
            if (exercise.unilateral) {
                updateGoButton(exerciseIdx, "1L");
                updateGoButton(exerciseIdx, "1R");
                updateGoButton(exerciseIdx, "2L");
                updateGoButton(exerciseIdx, "2R");
            } else {
                updateGoButton(exerciseIdx, 1);
                updateGoButton(exerciseIdx, 2);
            }
        }
        
        function updateGoButton(exerciseIdx, setId) {
            var weightInput = document.getElementById("weight-" + exerciseIdx);
            var btn = document.getElementById("btn-" + exerciseIdx + "-" + setId);
            if (!btn || btn.classList.contains("completed") || btn.classList.contains("stop")) return;
            
            var isUnilateral = typeof setId === "string";
            var timerKey = exerciseIdx + "-" + setId;
            var hasActiveTimer = Object.keys(timers).length > 0;
            var isThisTimerActive = timers[timerKey] !== undefined;
            
            if (hasActiveTimer && !isThisTimerActive) {
                btn.disabled = true;
                btn.textContent = "Wait...";
            } else if (weightInput.value && parseFloat(weightInput.value) > 0) {
                btn.textContent = "Go";
                btn.disabled = false;
            } else {
                btn.textContent = isUnilateral ? "Enter Wt" : "Enter Weight";
                btn.disabled = true;
            }
        }
        
        function handleTimer(exerciseIdx, setId) {
            var weightInput = document.getElementById("weight-" + exerciseIdx);
            var weight = parseFloat(weightInput.value);
            if (!weight || weight <= 0) {
                alert("Please enter a weight first!");
                return;
            }
            var timerKey = exerciseIdx + "-" + setId;
            if (timers[timerKey]) {
                stopTimer(exerciseIdx, setId);
            } else {
                startCountdown(exerciseIdx, setId);
            }
        }
        
        function startCountdown(exerciseIdx, setId) {
            var btn = document.getElementById("btn-" + exerciseIdx + "-" + setId);
            var display = document.getElementById("timer-" + exerciseIdx + "-" + setId);
            var weightInput = document.getElementById("weight-" + exerciseIdx);
            var countdown = 5;
            weightInput.disabled = true;
            display.textContent = countdown;
            display.classList.add("countdown");
            btn.textContent = "Ready...";
            btn.disabled = true;
            btn.classList.remove("go");
            beep(600, 150);
            var countdownInterval = setInterval(function() {
                countdown--;
                if (countdown > 0) {
                    display.textContent = countdown;
                    beep(600, 150);
                } else {
                    clearInterval(countdownInterval);
                    display.classList.remove("countdown");
                    beep(1000, 300);
                    startTimer(exerciseIdx, setId);
                }
            }, 1000);
        }
        
        function startTimer(exerciseIdx, setId) {
            var btn = document.getElementById("btn-" + exerciseIdx + "-" + setId);
            var display = document.getElementById("timer-" + exerciseIdx + "-" + setId);
            var timerKey = exerciseIdx + "-" + setId;
            var seconds = 0;
            var beeped70 = false;
            btn.disabled = false;
            btn.textContent = "Stop";
            btn.classList.add("stop");
            var interval = setInterval(function() {
                seconds++;
                display.textContent = formatTime(seconds);
                if (seconds === 70 && !beeped70) {
                    beeped70 = true;
                    display.classList.add("success");
                    beep(1000, 200, 3);
                }
            }, 1000);
            timers[timerKey] = { interval: interval, getSeconds: function() { return seconds; } };
            updateAllButtons();
        }
        
        function stopTimer(exerciseIdx, setId) {
            var timerKey = exerciseIdx + "-" + setId;
            var timerObj = timers[timerKey];
            var seconds = timerObj.getSeconds();
            clearInterval(timerObj.interval);
            delete timers[timerKey];
            var btn = document.getElementById("btn-" + exerciseIdx + "-" + setId);
            var isUnilateral = typeof setId === "string";
            btn.textContent = isUnilateral ? "Done" : "Completed";
            btn.classList.remove("stop");
            btn.classList.add("completed");
            btn.disabled = true;
            var workout = workouts[currentWorkout];
            var exercise = workout.exercises[exerciseIdx];
            if (exercise.unilateral) {
                if (setId === "1R") {
                    showRestOverlay(60);
                } else if (setId === "2R") {
                    saveUnilateralExercise(exerciseIdx);
                    showRestOverlay(90);
                }
            } else {
                if (setId === 2) {
                    saveBilateralExercise(exerciseIdx);
                }
                showRestOverlay(setId === 1 ? 60 : 90);
            }
            updateAllButtons();
        }
        
        function updateAllButtons() {
            var workout = workouts[currentWorkout];
            for (var idx = 0; idx < workout.exercises.length; idx++) {
                var exercise = workout.exercises[idx];
                if (exercise.unilateral) {
                    updateGoButton(idx, "1L");
                    updateGoButton(idx, "1R");
                    updateGoButton(idx, "2L");
                    updateGoButton(idx, "2R");
                } else {
                    updateGoButton(idx, 1);
                    updateGoButton(idx, 2);
                }
            }
        }
        
        function saveBilateralExercise(exerciseIdx) {
            var workout = workouts[currentWorkout];
            var exercise = workout.exercises[exerciseIdx];
            var weight = parseFloat(document.getElementById("weight-" + exerciseIdx).value) || 0;
            var time1 = parseTime(document.getElementById("timer-" + exerciseIdx + "-1").textContent);
            var time2 = parseTime(document.getElementById("timer-" + exerciseIdx + "-2").textContent);
            var entry = {
                date: new Date().toISOString().split("T")[0],
                workout: currentWorkout,
                exercise: exercise.name,
                weight: weight,
                time1: time1,
                time2: time2
            };
            saveToHistory(entry);
        }
        
        function saveUnilateralExercise(exerciseIdx) {
            var workout = workouts[currentWorkout];
            var exercise = workout.exercises[exerciseIdx];
            var weight = parseFloat(document.getElementById("weight-" + exerciseIdx).value) || 0;
            var time1L = parseTime(document.getElementById("timer-" + exerciseIdx + "-1L").textContent);
            var time1R = parseTime(document.getElementById("timer-" + exerciseIdx + "-1R").textContent);
            var time2L = parseTime(document.getElementById("timer-" + exerciseIdx + "-2L").textContent);
            var time2R = parseTime(document.getElementById("timer-" + exerciseIdx + "-2R").textContent);
            var entry = {
                date: new Date().toISOString().split("T")[0],
                workout: currentWorkout,
                exercise: exercise.name,
                weight: weight,
                time1L: time1L,
                time1R: time1R,
                time2L: time2L,
                time2R: time2R,
                unilateral: true
            };
            saveToHistory(entry);
        }
        
        function saveToHistory(entry) {
            var history = workoutHistoryData;
            var filtered = history.filter(function(h) { 
                return !(h.exercise === entry.exercise && h.workout === entry.workout && h.date === entry.date); 
            });
            filtered.push(entry);
            workoutHistoryData = filtered;
            saveWorkoutDataToGitHub();
            renderHistory();
        }
        
        function parseTime(timeStr) {
            var parts = timeStr.split(":");
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        
        function showRestOverlay(restSeconds) {
            var overlay = document.getElementById("restOverlay");
            var timerDisplay = document.getElementById("restTimer");
            overlay.classList.add("show");
            timerDisplay.textContent = restSeconds;
            restInterval = setInterval(function() {
                restSeconds--;
                timerDisplay.textContent = restSeconds;
                if (restSeconds <= 0) {
                    skipRest();
                    beep(800, 200, 2);
                }
            }, 1000);
        }
        
        function skipRest() {
            clearInterval(restInterval);
            document.getElementById("restOverlay").classList.remove("show");
        }
        
        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return (mins < 10 ? "0" : "") + mins + ":" + (secs < 10 ? "0" : "") + secs;
        }
        
        function renderHistory() {
            var historyContent = document.getElementById("historyContent");
            var history = workoutHistoryData;
            var durations = workoutDurationsData;
            var workoutHistory = history.filter(function(h) { return h.workout === currentWorkout; });
            workoutHistory.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
            var byDate = {};
            workoutHistory.forEach(function(entry) {
                if (!byDate[entry.date]) byDate[entry.date] = [];
                byDate[entry.date].push(entry);
            });
            var html = "";
            var dates = Object.keys(byDate).slice(0, 5);
            dates.forEach(function(date, i) {
                var dateObj = new Date(date + "T12:00:00");
                var dateStr = dateObj.toLocaleDateString("en-US", { month: "short", day: "numeric" });
                var key = date + "-" + currentWorkout;
                var durationStr = durations[key] ? " <span class=\"history-duration\">(" + durations[key] + " min)</span>" : "";
                
                html += "<span class=\"history-date\">" + dateStr + "</span>" + durationStr;
                html += "<span class=\"history-edit-icon\" onclick=\"toggleHistoryEdit('" + key + "')\">✏️</span>\n";
                
                var editText = "";
                byDate[date].forEach(function(entry) {
                    if (entry.unilateral) {
                        html += entry.exercise + ": " + entry.weight + "lb → " + entry.time1L + "s, " + entry.time1R + "s, " + entry.time2L + "s, " + entry.time2R + "s\n";
                        editText += entry.exercise + ": " + entry.weight + "lb → " + entry.time1L + "s, " + entry.time1R + "s, " + entry.time2L + "s, " + entry.time2R + "s\n";
                    } else {
                        html += entry.exercise + ": " + entry.weight + "lb → " + entry.time1 + "s, " + entry.time2 + "s\n";
                        editText += entry.exercise + ": " + entry.weight + "lb → " + entry.time1 + "s, " + entry.time2 + "s\n";
                    }
                });
                
                html += "<div class=\"history-edit-container\" id=\"edit-" + key + "\">";
                html += "<textarea class=\"history-edit-textarea\" id=\"textarea-" + key + "\">" + editText.trim() + "</textarea>";
                html += "<div class=\"history-edit-buttons\">";
                html += "<button class=\"history-edit-btn cancel\" onclick=\"toggleHistoryEdit('" + key + "')\">Cancel</button>";
                html += "<button class=\"history-edit-btn save\" onclick=\"saveHistoryEdit('" + key + "')\">Save</button>";
                html += "</div></div>";
                
                if (i < dates.length - 1) html += "\n";
            });
            historyContent.innerHTML = html || "No history yet";
        }
        
        function saveWorkoutDataToGitHub() {
            saveWorkoutData({
                workoutHistory: workoutHistoryData,
                workoutDurations: workoutDurationsData
            }).catch(function(err) {
                console.error("GitHub sync failed:", err);
            });
        }
        
        function toggleHistoryEdit(key) {
            var container = document.getElementById("edit-" + key);
            if (container) {
                container.classList.toggle("show");
            }
        }
        
        function saveHistoryEdit(key) {
            var textarea = document.getElementById("textarea-" + key);
            var text = textarea.value.trim();
            var lines = text.split("\n");
            
            var parts = key.split("-");
            var date = parts.slice(0, 3).join("-");
            var workout = parts[3];
            
            var history = workoutHistoryData;
            history = history.filter(function(h) {
                return !(h.date === date && h.workout === workout);
            });
            
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line) continue;
                
                var match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)lb\s*→\s*(.+)$/);
                if (!match) continue;
                
                var exerciseName = match[1].trim();
                var weight = parseFloat(match[2]);
                var timesStr = match[3];
                var times = timesStr.split(",").map(function(t) { return parseInt(t.trim()) || 0; });
                
                var entry = {
                    date: date,
                    workout: workout,
                    exercise: exerciseName,
                    weight: weight
                };
                
                if (times.length === 4) {
                    entry.time1L = times[0];
                    entry.time1R = times[1];
                    entry.time2L = times[2];
                    entry.time2R = times[3];
                    entry.unilateral = true;
                } else if (times.length >= 2) {
                    entry.time1 = times[0];
                    entry.time2 = times[1];
                }
                
                history.push(entry);
            }
            
            workoutHistoryData = history;
            saveWorkoutDataToGitHub();
            
            toggleHistoryEdit(key);
            renderHistory();
            loadWorkout(currentWorkout);
        }
        
        window.loadWorkout = loadWorkout;
        window.onWeightInput = onWeightInput;
        window.handleTimer = handleTimer;
        window.skipRest = skipRest;
        window.toggleHistoryEdit = toggleHistoryEdit;
        window.saveHistoryEdit = saveHistoryEdit;
        
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
```